# 模型部署

![img](assets/v2-59b12a53cb37514ca9fa0126612c6d25_720w.webp)

# 推理引擎

推理引擎由**CUDA**或**OpenCL**等高性能面向硬件的框架编写，把中间表示转化成特定文件格式，在对应硬件平台上运行。

## 1、TensorRT

TensorRT是可以在**NVIDIA**各种**GPU硬件平台**下运行的一个**C++推理框架**，利用Pytorch、TF或者其他框架训练好的模型，可以转化为TensorRT的格式，然后利用TensorRT推理引擎去运行我们这个模型，从而提升这个模型在英伟达GPU上运行的速度。

**TensorRT专注于推理**



### 1.1 TensorRT

### 1.2 转TensorRT

TensorRT获取网络结构的三种方式：

- 使用`TF-TRT`，将TensorRT集成在TensorFlow中
- 使用`ONNX2TensorRT`，即ONNX转换trt的工具
- 手动构造模型结构，然后手动将权重信息挪过去，非常灵活但是时间成本略高，有大佬已经尝试过了：[tensorrtx](https://link.zhihu.com/?target=https%3A//github.com/wang-xinyu/tensorrtx)



### 1.3 Dynamic Batch



# 中间表示

中间表示只描述网络结构，针对网络结构做出优化。

## 1、计算图

见《机器学习系统：设计和实现》第四章

## 2、ONNX

### 2.1Pytorch转Onnx

Pytorch中自带了一个将模型转为Onnx的API，`torch.onnx.export`。

```python
torch.onnx.export(model, args, f, export_params=True, verbose=False, training=<TrainingMode.EVAL: 0>, input_names=None, output_names=None, operator_export_type=<OperatorExportTypes.ONNX: 0>, opset_version=None, do_constant_folding=True, dynamic_axes=None, keep_initializers_as_inputs=None, custom_opsets=None, export_modules_as_functions=False, autograd_inlining=True)
```

但是这个API能够接受许多参数，下面是一些比较重要的参数：

- **model([`torch.nn.Module`](https://pytorch.org/docs/stable/generated/torch.nn.Module.html#torch.nn.Module), [`torch.jit.ScriptModule`](https://pytorch.org/docs/stable/generated/torch.jit.ScriptModule.html#torch.jit.ScriptModule) or [`torch.jit.ScriptFunction`](https://pytorch.org/docs/stable/generated/torch.jit.ScriptFunction.html#torch.jit.ScriptFunction))** 模型结构
- **args** 模型的输入
- **f** 导出的onnx文件名
- **export_params** 这个选项用以



## 2.2 深入ONNX





## 3、Torchscript



# 深度学习框架

## 1、Pytorch

### 1.1 Pytorch中的模型的保存与读取

Pytorch的模型的存储格式有pkl，pt，pth。而对于checkpoint采用tar格式保存。

Pytorch的模型主要包含两个部分：模型结构和权重。其中模型是继承nn.Module的类，权重的数据结构是一个字典（key是层名，value是权重向量）。存储也由此分为两种形式：存储整个模型（包括结构和权重），和只存储模型权重。

pkl，pt，pth三种格式都支持只存储权重和存储整个模型。



# 芯片的算力指标

FLOPS，TOPS，MACs



# 模型序列化

[这里](./Jetson部署.md#1.1.1-序列化(serialization)与反序列化(deserialization))讲解了序列化与反序列化以及模型的保存。现在更加详细的讲一下一个模型中有哪些内容。





