# 性能工程(Performance Engineering)



# 1. Introduction

对于软件，一切我们想要的一些软件特性：compatibility、reliability、robustness等等，这些性质都需要用性能来换取，所以**性能是计算机中的通货**。

```
Perfromance is the currency of computing
```



## 1.1 从矩阵乘法切入

对于一个矩阵乘法，vanilla的实现方式就是一个三层循环

```c
for(int i = 0; i < n;i++) {
    for(int j = 0;j < n;j++) {
        for(int k = 0;k < n;k++) {
            C[i][j] += A[i][k] * B[k][j];
        }
    }
}
```

时间复杂度O(n\^3)，FLOPs为2n\^3。



以两个4096维度的方阵乘法为例，整个矩阵乘法所需要的运算量是2 * 4096 * 4096 * 4096 = 2^37 = 137.439GFLOPs

<img src="assets/image-20240915131455377.png" alt="image-20240915131455377" style="zoom:50%;" />

而拿MIT6.172课程中的服务器运行，这个矩阵乘法运算如果用Python实现，需要24042s。做一个back-of-the-envelope计算
$$
Peak \ Throughput = 836GFLOPS \\
Python \ Troughput = 2^{37} / 21042 = 6.25MFLOPS
$$
实际上Python实现只能够达到0.0075%的峰值吞吐。



下面我们对这个矩阵乘法不断改进，来看最终能够优化到什么程度。



### 1.1.1 Programming Language





### 1.1.2 Loop Order

循环的顺序对于矩阵乘法的影响是因为Cache。特定的循环顺序能够具有更好的局部性，能减少Cache miss。

对于三层循环，一共有6种循环的顺序

1)i，j，k顺序，这是最常用的顺序，但是局部性不是最优的

<img src="assets/image-20240915133422837.png" alt="image-20240915133422837" style="zoom:50%;" />

2)i，k，j顺序，这样能获得非常好的局部性

<img src="assets/image-20240915133545919.png" alt="image-20240915133545919" style="zoom:50%;" />

3)j，k，i顺序，这样的局部性是最差的

<img src="assets/image-20240915133713631.png" alt="image-20240915133713631" style="zoom:50%;" />

4)k，i，j顺序，上面的i，k，j顺序局部性已经非常好了，但是k，i，j也能获得非常好的局部性，有时性能比i，k，j顺序还要好一些







### 1.1.3 Compiler Optimization

现代编译器都有不同级别的编译器优化选项，从-O0到-O3，优化级别越来越高。但是并不是优化级别越高越好，有可能-O2比-O3表现要好。因为编译器的-O3优化的优化策略有时比较激进。



### 1.1.4 Parallel Loops

多核并行能显著提升性能。但是在多核并行时，对不同的循环并行也会带来不同的性能差异。并且，并不是所有的循环都能并行。



### 1.1.5 Tiling And Multi-level Tiling

循环分块同样是利用到了Cache。



<img src="assets/image-20240915140547036.png" alt="image-20240915140547036" style="zoom:50%;" />

<img src="assets/image-20240915140600370.png" alt="image-20240915140600370" style="zoom:50%;" />



而分块的大小则需要多次实验选择出最佳的分块大小。



现代计算机的Memory Hierarchy有着多级Cache，为了能够充分利用多级Cache，需要多级分块。多级分块有多个需要调整的参数s，t等等。



### 1.1.6 并行分治



### 1.1.7 Compiler Vectorization



### 1.1.8 AVX intrinsics



[Intrinsics](https://en.wikipedia.org/wiki/Intrinsic_function)(Intrinsic Function)，是一种在高级语言中提供对特定CPU指令集访问的方法。它们通常由编译器提供，允许开发者在不直接写汇编代码的情况下利用特定的CPU指令。

不同的指令集架构都有







Moore's law于



性能工程的核心是**底层硬件提供了什么特性 + 上层软件如何利用硬件提供的特性**。



Moore's law与Dennard Scaling



<img src="assets/image-20240915104138819.png" alt="image-20240915104138819" style="zoom:67%;" />



# 性能测量

wall-clock time和CPU time



插桩(源代码/二进制文件)



CPU上的性能计数器PMU



乘法和加法fuse，FMA



eBPF与tracing



随机误差(无法改变)和系统误差(可以消除)





# Appendix

## Linux Perf使用

